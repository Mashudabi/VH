name: Deploy backend (Render) and frontend (Vercel)

on:
  push:
    branches: [ main ]

jobs:
  deploy-backend:
    name: Deploy backend to Render
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Trigger Render deploy via API
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "Missing Render secrets. Set RENDER_API_KEY and RENDER_SERVICE_ID in repo secrets.";
            exit 1;
          fi
          echo "Triggering deploy for service: $RENDER_SERVICE_ID"
          curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": true}'

  deploy-frontend:
    name: Deploy frontend to Vercel
    runs-on: ubuntu-latest
    needs: deploy-verify
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: --prod
          working-directory: ./public
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

  deploy-verify:
    name: Verify backend is responding
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Wait for backend to become healthy
        env:
          RENDER_URL: ${{ secrets.RENDER_URL }}
        run: |
          if [ -z "$RENDER_URL" ]; then
            echo "RENDER_URL secret is not set. Add the public URL of your Render service as RENDER_URL.";
            exit 1;
          fi

          echo "Polling $RENDER_URL/api/dashboard-background for up to 2 minutes..."
          MAX_TRIES=24
          SLEEP=5
          n=0
          while [ $n -lt $MAX_TRIES ]; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "$RENDER_URL/api/dashboard-background" || echo "000")
            echo "Attempt $((n+1)) - HTTP status: $status"
            if [ "$status" = "200" ]; then
              echo "Backend responded with 200. Proceeding."
              exit 0
            fi
            n=$((n+1))
            sleep $SLEEP
          done
          echo "Backend did not respond with 200 within timeout. Failing the job."
          exit 1
